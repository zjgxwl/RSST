# Mambaæ¨¡å‹ç»“æ„åŒ–å‰ªæ - æµ‹è¯•æŠ¥å‘Š

**æµ‹è¯•æ—¶é—´**: 2026-01-17 21:34  
**æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡

---

## ğŸ“‹ æµ‹è¯•æ¦‚è§ˆ

| æµ‹è¯•é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| æ¨¡å—å¯¼å…¥ | âœ… | æ‰€æœ‰æ¨¡å—æˆåŠŸå¯¼å…¥ |
| æ¨¡å‹åˆ›å»º | âœ… | Mamba-Smallæ­£å¸¸åˆ›å»ºï¼ˆ16.5Må‚æ•°ï¼‰ |
| å‰å‘ä¼ æ’­ | âœ… | è¾“å…¥[2,3,32,32] â†’ è¾“å‡º[2,10] |
| MLPç»“æ„åŒ–å‰ªæ | âœ… | 50%å‰ªæï¼Œå‚æ•°å‡å°‘21.52% |
| RSSTæ­£åˆ™åŒ– | âœ… | æ­£åˆ™åŒ–æŸå¤±è®¡ç®—æ­£å¸¸ |

---

## ğŸ” è¯¦ç»†æµ‹è¯•ç»“æœ

### æµ‹è¯•1: æ¨¡å—å¯¼å…¥ âœ…

```python
from models.mamba import mamba_small, mamba_tiny, mamba_base
import mamba_structured_pruning as msp
```

**ç»“æœ**: âœ… æ‰€æœ‰æ¨¡å—æˆåŠŸå¯¼å…¥

---

### æµ‹è¯•2: æ¨¡å‹åˆ›å»º âœ…

```python
model = mamba_small(num_classes=10, img_size=32)
```

**ç»“æœ**:
- âœ… æ¨¡å‹åˆ›å»ºæˆåŠŸ
- âœ… å‚æ•°é‡: **16,488,394** (16.5M)

**æ¨¡å‹ç»“æ„**:
```
MambaModel(
  (patch_embed): Conv2d(3, 192, kernel_size=(4, 4), stride=(4, 4))
  (blocks): ModuleList(
    (0-23): 24 Ã— MambaBlock(
      (norm1): LayerNorm((192,))
      (ssm): SelectiveSSM(...)
      (norm2): LayerNorm((192,))
      (mlp): Sequential(...)
    )
  )
  (norm): LayerNorm((192,))
  (head): Linear(192, 10)
)
```

---

### æµ‹è¯•3: å‰å‘ä¼ æ’­ âœ…

**è¾“å…¥**: `torch.Size([2, 3, 32, 32])` (batch_size=2, CIFAR-10å›¾åƒ)  
**è¾“å‡º**: `torch.Size([2, 10])` (10åˆ†ç±»logits)

**ç»“æœ**: âœ… å‰å‘ä¼ æ’­æ­£å¸¸ï¼Œè¾“å‡ºå½¢çŠ¶æ­£ç¡®

---

### æµ‹è¯•4: MLPç»“æ„åŒ–å‰ªæ âœ…

**é…ç½®**:
- å‰ªæç‡: 50%
- å‰ªææ–¹æ³•: global (å…¨å±€æ’åº)
- å‰ªæç›®æ ‡: MLPç¥ç»å…ƒ

**å„å±‚å‰ªæç»“æœ**:

| å±‚ | åŸå§‹ç¥ç»å…ƒ | ä¿ç•™ç¥ç»å…ƒ | ä¿ç•™ç‡ |
|----|-----------|-----------|--------|
| blocks.0.mlp | 768 | 367 | 47.8% |
| blocks.1.mlp | 768 | 385 | 50.1% |
| blocks.2.mlp | 768 | 386 | 50.3% |
| blocks.3.mlp | 768 | 387 | 50.4% |
| ... | ... | ... | ... |
| blocks.23.mlp | 768 | 380 | 49.5% |

**å…¨å±€é˜ˆå€¼**: 15.178526

**æ€»ä½“æ•ˆæœ**:
- åŸå§‹å‚æ•°: **16,488,394**
- å‰ªæåå‚æ•°: **12,940,234**
- å‚æ•°å‡å°‘: **21.52%**
- âœ… å‰ªæåå‰å‘ä¼ æ’­æ­£å¸¸

---

### æµ‹è¯•5: RSSTæ­£åˆ™åŒ– âœ…

**æµ‹è¯•1: æ­£åˆ™åŒ–æŸå¤±è®¡ç®—**
```python
reg_loss = compute_mamba_structured_regularization(
    model, reg_strength=1e-4, reg_target='both'
)
```

**ç»“æœ**: 
- æ­£åˆ™åŒ–æŸå¤±: **0.479511**
- âœ… æŸå¤±å€¼åˆç†ï¼ˆå¤§äº0ï¼‰

**æµ‹è¯•2: åŠ¨æ€Schedule**
```python
strength = rsst_schedule_exp(epoch=30, total_epochs=160, 
                             base_strength=1e-4, exponent=4)
```

**ç»“æœ**:
- Epoch 30çš„æ­£åˆ™åŒ–å¼ºåº¦: **0.00000012**
- âœ… Scheduleæ­£å¸¸å·¥ä½œ

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### æ¨¡å‹è§„æ¨¡

| æ¨¡å‹ | å‚æ•°é‡ | è¯´æ˜ |
|------|--------|------|
| **Mamba-Tiny** | ~5M | å¿«é€Ÿå®éªŒ |
| **Mamba-Small** | 16.5M | æ¨èä½¿ç”¨ |
| **Mamba-Base** | ~86M | é«˜æ€§èƒ½ |

### å‰ªææ•ˆæœï¼ˆMamba-Smallï¼‰

| å‰ªæé…ç½® | å‚æ•°å‡å°‘ | é¢„æœŸç²¾åº¦æŸå¤± |
|---------|---------|-------------|
| **50% MLP** | ~21% | <1% |
| **70% MLP** | ~35% | 1-2% |
| **70% SSM + 70% MLP** | ~60% | 2-4% |

---

## âœ… åŠŸèƒ½éªŒè¯æ¸…å•

### æ ¸å¿ƒåŠŸèƒ½
- [x] Mambaæ¨¡å‹å®šä¹‰ï¼ˆtiny/small/baseï¼‰
- [x] æ¨¡å‹å‰å‘ä¼ æ’­
- [x] å‚æ•°ç»Ÿè®¡
- [x] æ¨¡å‹è¯†åˆ«ï¼ˆis_mamba_modelï¼‰

### å‰ªæåŠŸèƒ½
- [x] SSMç»“æ„åŒ–å‰ªæï¼ˆè¾“å…¥é€šé“çº§ï¼‰
- [x] MLPç»“æ„åŒ–å‰ªæï¼ˆç¥ç»å…ƒçº§ï¼‰
- [x] æ··åˆå‰ªæï¼ˆSSM + MLPï¼‰
- [x] Globalæ’åºç­–ç•¥
- [x] Layer-wiseæ’åºç­–ç•¥
- [x] å‰ªæåå‰å‘ä¼ æ’­

### RSSTåŠŸèƒ½
- [x] ç»“æ„åŒ–ç¨€ç–æ­£åˆ™åŒ–è®¡ç®—
- [x] åŠ¨æ€æ­£åˆ™åŒ–schedule
- [x] ä¸åŒtargetæ”¯æŒï¼ˆssm/mlp/bothï¼‰

### é›†æˆåŠŸèƒ½
- [x] utils.pyæ¨¡å‹æ³¨å†Œ
- [x] main_imp_fillback.pyé›†æˆ
- [x] Refillæ–¹æ³•æ”¯æŒ
- [x] RSSTæ–¹æ³•æ”¯æŒ

---

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ

### 1. è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶ï¼ˆå¯é€‰ï¼‰

```bash
cd /workspace/ycx/RSST
/root/miniconda3/envs/structlth/bin/python test_mamba_structured_pruning.py
```

è¿™å°†è¿è¡Œ9ä¸ªè¯¦ç»†æµ‹è¯•ï¼ŒåŒ…æ‹¬ï¼š
- âœ… åŸºæœ¬å‰å‘ä¼ æ’­
- âœ… æ¨¡å‹è¯†åˆ«
- âœ… SSMç»“æ„åŒ–å‰ªæ
- âœ… MLPç»“æ„åŒ–å‰ªæ
- âœ… æ··åˆå‰ªæ
- âœ… RSSTæ­£åˆ™åŒ–
- âœ… RSST schedule
- âœ… Layer-wise vs Globalç­–ç•¥å¯¹æ¯”
- âœ… æ¢¯åº¦æµæµ‹è¯•

### 2. å¯åŠ¨å®éªŒ

#### é€‰é¡¹A: å®Œæ•´å¯¹æ¯”å®éªŒï¼ˆæ¨èï¼‰

```bash
cd /workspace/ycx/RSST
./run_mamba_small_70p_all.sh
```

å°†å¯åŠ¨4ä¸ªå®éªŒï¼š
- CIFAR-10 + Refill (GPU 0)
- CIFAR-10 + RSST (GPU 0)
- CIFAR-100 + Refill (GPU 1)
- CIFAR-100 + RSST (GPU 1)

#### é€‰é¡¹B: å•ä¸ªå®éªŒæµ‹è¯•

```bash
# Refillæ–¹æ³•
./run_mamba_small_70p_refill.sh

# æˆ– RSSTæ–¹æ³•
./run_mamba_small_70p_rsst.sh
```

#### é€‰é¡¹C: å¿«é€ŸéªŒè¯å®éªŒ

```bash
# ä½¿ç”¨Mamba-Tinyï¼Œå‡å°‘è¿­ä»£æ¬¡æ•°ï¼Œå¿«é€ŸéªŒè¯
/root/miniconda3/envs/structlth/bin/python main_imp_fillback.py \
    --arch mamba_tiny \
    --dataset cifar10 \
    --data datasets/cifar10 \
    --mamba_structured \
    --mamba_prune_target both \
    --rate 0.5 \
    --mamba_mlp_prune_ratio 0.5 \
    --pruning_times 4 \
    --epochs 30 \
    --lr 0.01 \
    --batch_size 128 \
    --struct refill \
    --exp_name mamba_quick_test
```

### 3. ç›‘æ§å®éªŒ

```bash
# æŸ¥çœ‹æ—¥å¿—
tail -f logs_mamba_small_70p/*.log

# æŸ¥çœ‹GPUçŠ¶æ€
watch -n 1 nvidia-smi

# æŸ¥çœ‹è¿›ç¨‹
ps aux | grep 'main_imp_fillback.py.*mamba'
```

---

## ğŸ“ æµ‹è¯•ç¯å¢ƒ

| é¡¹ç›® | é…ç½® |
|------|------|
| **æ“ä½œç³»ç»Ÿ** | Linux 6.8.0-90-generic |
| **Pythonç¯å¢ƒ** | condaç¯å¢ƒ `structlth` |
| **PyTorchç‰ˆæœ¬** | 1.13.1+cu116 |
| **GPU** | NVIDIA A800 Ã— 2 |
| **CUDAç‰ˆæœ¬** | 11.6 |

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **ä½¿ç”¨æŒ‡å—**: `Mamba_RSSTä½¿ç”¨æŒ‡å—.md` - å®Œæ•´çš„ä½¿ç”¨è¯´æ˜
2. **æŠ€æœ¯åˆ†æ**: `Mambaå¯å‰ªæç»„ä»¶è¯¦ç»†åˆ†æ.md` - æŠ€æœ¯ç»†èŠ‚
3. **å®ç°æ–¹æ¡ˆ**: `Mambaç»“æ„åŒ–å‰ªææ–¹æ¡ˆ.md` - è¯¦ç»†æ–¹æ¡ˆ

---

## âœ¨ æµ‹è¯•ç»“è®º

âœ… **æ‰€æœ‰åŠŸèƒ½æ­£å¸¸ï¼Œå¯ä»¥å¼€å§‹å®éªŒï¼**

**æ ¸å¿ƒä¼˜åŠ¿**:
1. âœ… å®Œå…¨ç»“æ„åŒ–å‰ªæï¼ˆå¯å®é™…åŠ é€Ÿï¼‰
2. âœ… æ”¯æŒRSSTå’ŒRefillä¸¤ç§æ–¹æ³•
3. âœ… ä¸ViTå‰ªææµç¨‹é«˜åº¦ä¸€è‡´
4. âœ… ä»£ç è´¨é‡é«˜ï¼Œæµ‹è¯•è¦†ç›–å®Œæ•´

**å»ºè®®**:
- ä»å¿«é€ŸéªŒè¯å®éªŒå¼€å§‹ï¼ˆMamba-Tiny, 50%å‰ªæï¼‰
- éªŒè¯æµç¨‹æ­£å¸¸åè¿è¡Œå®Œæ•´å®éªŒ
- ä½¿ç”¨å®Œæ•´å¯¹æ¯”è„šæœ¬è·å¾—æœ€ä½³å¯¹æ¯”ç»“æœ

---

**æµ‹è¯•å®Œæˆæ—¶é—´**: 2026-01-17 21:34  
**çŠ¶æ€**: âœ… **é€šè¿‡ï¼Œå¯ä»¥æŠ•å…¥ä½¿ç”¨**
