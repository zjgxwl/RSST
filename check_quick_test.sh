#!/bin/bash

################################################################################
# å¿«é€Ÿæµ‹è¯•ç›‘æ§è„šæœ¬
################################################################################

# æŸ¥æ‰¾æœ€æ–°çš„æ—¥å¿—æ–‡ä»¶
LOG_FILE=$(ls -t logs_vit_quick_test/quick_test_*.log 2>/dev/null | head -1)

if [ -z "${LOG_FILE}" ]; then
    echo "âŒ æœªæ‰¾åˆ°æµ‹è¯•æ—¥å¿—æ–‡ä»¶"
    exit 1
fi

echo "========================================================================"
echo "ViTå¿«é€Ÿæµ‹è¯• - å®æ—¶ç›‘æ§"
echo "========================================================================"
echo ""
echo "æ—¥å¿—æ–‡ä»¶: ${LOG_FILE}"
echo ""

# æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿˜åœ¨è¿è¡Œ
if ps aux | grep -v grep | grep "main_imp_fillback.py.*quick_test" > /dev/null; then
    echo "âœ“ æµ‹è¯•è¿›ç¨‹æ­£åœ¨è¿è¡Œ"
else
    echo "âš ï¸  æµ‹è¯•è¿›ç¨‹å·²ç»“æŸæˆ–æœªå¯åŠ¨"
fi

echo ""
echo "========================================================================"
echo "ğŸ“Š è®­ç»ƒè¿›åº¦"
echo "========================================================================"
echo ""

# æ˜¾ç¤ºå½“å‰State
CURRENT_STATE=$(grep "pruning state" ${LOG_FILE} | tail -1)
if [ ! -z "${CURRENT_STATE}" ]; then
    echo "å½“å‰State: ${CURRENT_STATE}"
fi

# æ˜¾ç¤ºæœ€è¿‘çš„è®­ç»ƒæ—¥å¿—ï¼ˆæœ€å10è¡ŒEpochä¿¡æ¯ï¼‰
echo ""
echo "æœ€è¿‘è®­ç»ƒè®°å½•:"
grep -E "Epoch: \[[0-9]+\]\[[0-9]+/352\]" ${LOG_FILE} | tail -10

# æ˜¾ç¤ºæµ‹è¯•å‡†ç¡®ç‡
echo ""
echo "æµ‹è¯•å‡†ç¡®ç‡:"
grep -E "Test: \[[0-9]+/[0-9]+\].*Accuracy" ${LOG_FILE} | tail -5

# æ˜¾ç¤ºæœ€ä½³å‡†ç¡®ç‡
echo ""
BEST_SA=$(grep "best SA=" ${LOG_FILE} | tail -1)
if [ ! -z "${BEST_SA}" ]; then
    echo "æœ€ä½³å‡†ç¡®ç‡: ${BEST_SA}"
fi

echo ""
echo "========================================================================"
echo "ğŸ” å…³é”®æ£€æŸ¥ç‚¹"
echo "========================================================================"
echo ""

# æ£€æŸ¥State 0
if grep -q "pruning state 0" ${LOG_FILE}; then
    echo "âœ“ State 0å·²å¼€å§‹"
else
    echo "â³ State 0å°šæœªå¼€å§‹"
fi

# æ£€æŸ¥å‰ªææ“ä½œ
if grep -q "ViT Pruning\|Pruning completed" ${LOG_FILE}; then
    echo "âœ“ å‰ªææ“ä½œå·²æ‰§è¡Œ"
    # æ˜¾ç¤ºå‰ªæä¿¡æ¯
    grep -A 5 "ViT Head + MLP" ${LOG_FILE} | head -6
else
    echo "â³ å‰ªæå°šæœªæ‰§è¡Œ"
fi

# æ£€æŸ¥State 1 â† å…³é”®ï¼
if grep -q "pruning state 1" ${LOG_FILE}; then
    echo "âœ“ State 1å·²å¼€å§‹ â† å…³é”®ï¼ä¿®å¤æœ‰æ•ˆï¼"
else
    echo "â³ State 1å°šæœªå¼€å§‹"
fi

# æ£€æŸ¥æ˜¯å¦æœ‰è®¾å¤‡é”™è¯¯ â† æœ€å…³é”®çš„æ£€æŸ¥ï¼
echo ""
echo "========================================================================"
echo "ğŸš¨ è®¾å¤‡é”™è¯¯æ£€æŸ¥ï¼ˆæœ€å…³é”®ï¼‰"
echo "========================================================================"
echo ""

if grep -q "RuntimeError.*device\|Expected all tensors to be on the same device" ${LOG_FILE}; then
    echo "âŒ å‘ç°è®¾å¤‡ä¸åŒ¹é…é”™è¯¯ï¼ä¿®å¤å¯èƒ½ä¸å®Œæ•´"
    echo ""
    echo "é”™è¯¯è¯¦æƒ…:"
    grep -B 5 -A 10 "RuntimeError" ${LOG_FILE} | tail -15
else
    echo "âœ… æœªå‘ç°è®¾å¤‡ä¸åŒ¹é…é”™è¯¯ - ä¿®å¤æœ‰æ•ˆï¼"
fi

echo ""
echo "========================================================================"
echo "ğŸ“Œ å¿«é€ŸæŸ¥çœ‹å‘½ä»¤"
echo "========================================================================"
echo ""
echo "# å®æ—¶ç›‘æ§æ—¥å¿—"
echo "tail -f ${LOG_FILE}"
echo ""
echo "# æŸ¥çœ‹è®­ç»ƒè¿›åº¦"
echo "grep -E 'Epoch.*\[.*\]|pruning state|best SA' ${LOG_FILE} | tail -20"
echo ""
echo "# æŸ¥çœ‹å®Œæ•´å‰ªæç»Ÿè®¡"
echo "grep -A 50 'ViT Sparsity Report' ${LOG_FILE} | tail -55"
echo ""
echo "# é‡æ–°è¿è¡Œæ­¤ç›‘æ§è„šæœ¬"
echo "./check_quick_test.sh"
echo ""
echo "========================================================================"
