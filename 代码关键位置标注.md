# RSSTé¡¹ç›®å…³é”®ä»£ç ä½ç½®æ ‡æ³¨

## ğŸ¯ ä¸€ã€æ¨¡å‹æ›¿æ¢ä½ç½®é€ŸæŸ¥

### æ–¹æ¡ˆ1ï¼šå¿«é€Ÿæ›¿æ¢ï¼ˆæ¨èæ–°æ‰‹ï¼‰
ç›´æ¥ä¿®æ”¹ `utils.py` ç¬¬92-94è¡Œï¼š

```python
# æ–‡ä»¶ï¼šutils.py
# è¡Œå·ï¼š92-94
elif args.arch == 'res20s':
    print('build model: resnet20')
    model = resnet20(number_class=classes)
```

**æ”¹æˆä½ çš„æ¨¡å‹ï¼š**
```python
elif args.arch == 'res20s':
    print('build model: my_custom_model')
    model = MyCustomModel(num_classes=classes)  # æ›¿æ¢è¿™é‡Œ
```

### æ–¹æ¡ˆ2ï¼šæ·»åŠ æ–°é€‰é¡¹ï¼ˆæ¨èï¼‰

**æ­¥éª¤1ï¼š** åˆ›å»ºæ¨¡å‹æ–‡ä»¶ `models/my_resnet.py`

**æ­¥éª¤2ï¼š** åœ¨ `utils.py` é¡¶éƒ¨æ·»åŠ å¯¼å…¥ï¼ˆç¬¬1-16è¡Œä¹‹é—´ï¼‰
```python
from models.my_resnet import my_resnet50
```

**æ­¥éª¤3ï¼š** åœ¨ `utils.py` çš„ `setup_model_dataset()` å‡½æ•°ä¸­æ·»åŠ ï¼ˆç¬¬126è¡Œåï¼‰
```python
elif args.arch == 'my_resnet50':
    print('build model: my_resnet50')
    model = my_resnet50(num_classes=classes)
```

**æ­¥éª¤4ï¼š** è¿è¡Œæ—¶æŒ‡å®š
```bash
python main_imp_fillback.py --arch my_resnet50
```

---

## ğŸ”¥ äºŒã€å‰ªææ–¹æ³•ä½ç½®æ ‡æ³¨

### 2.1 ä¸»å‰ªæå¾ªç¯
ğŸ“ **æ–‡ä»¶ï¼š** `main_imp_fillback.py`
ğŸ“ **è¡Œå·ï¼š** 209-351

```
ç¬¬209è¡Œ: for state in range(start_state, args.pruning_times):
    â”œâ”€ ç¬¬225-268è¡Œ: è®­ç»ƒå¾ªç¯ (120 epochs)
    â”œâ”€ ç¬¬270-305è¡Œ: [RSSTä¸“ç”¨] æ­£åˆ™åŒ–åé‡ç½®æƒé‡
    â”œâ”€ ç¬¬321è¡Œ: æ‰§è¡Œå‰ªæ pruning_model()
    â”œâ”€ ç¬¬324è¡Œ: æå–mask
    â””â”€ ç¬¬330-343è¡Œ: Refill/RSSTåˆ†æ”¯é€‰æ‹©
```

### 2.2 å…¨å±€L1å‰ªæå®ç°
ğŸ“ **æ–‡ä»¶ï¼š** `pruning_utils.py`
ğŸ“ **è¡Œå·ï¼š** 6-22

```python
def pruning_model(model, px, conv1=False):
    # ç¬¬10-14è¡Œ: æ”¶é›†æ‰€æœ‰å·ç§¯å±‚
    for name, m in model.named_modules():
        if isinstance(m, nn.Conv2d):
            parameters_to_prune.append((m, 'weight'))
    
    # ç¬¬18-22è¡Œ: æ‰§è¡Œå…¨å±€L1å‰ªæ
    prune.global_unstructured(
        parameters_to_prune,
        pruning_method=prune.L1Unstructured,  # â­ L1èŒƒæ•°å‰ªæ
        amount=px,  # â­ å‰ªæç‡
    )
```

**è°ƒç”¨ä½ç½®ï¼š**
```
main_imp_fillback.py:321
    â””â”€ pruning_model(model, args.rate, conv1=False)
```

### 2.3 Refillç®—æ³•å®ç°
ğŸ“ **æ–‡ä»¶ï¼š** `pruning_utils.py`
ğŸ“ **è¡Œå·ï¼š** 77-243

**æ ¸å¿ƒè®¡ç®—ä½ç½®ï¼š**

#### æŒ‰æƒé‡å¹…åº¦ï¼ˆmagnitudeï¼‰
```
ç¬¬175-188è¡Œ:
    count = trained_weight[name + '.weight'].abs().sum(1)  â­ è®¡ç®—æ¯ä¸ªé€šé“æƒé‡å’Œ
    threshold = torch.kthvalue(count, mask.shape[0] - int_channel)  â­ æ‰¾é˜ˆå€¼
    mask[count > threshold] = 1  â­ æ›´æ–°mask
```

#### æŒ‰ç‰¹å¾å›¾L1èŒƒæ•°
```
ç¬¬190-201è¡Œ:
    count = feature_maps[counter].abs().sum(1)  â­ ç‰¹å¾å›¾L1èŒƒæ•°
    threshold = torch.kthvalue(count, ...)
    mask[count > threshold] = 1
```

#### æŒ‰æ˜¾è‘—æ€§ï¼ˆsaliencyï¼‰
```
ç¬¬215-226è¡Œ:
    count = (feature_maps[counter] *   â­ ç‰¹å¾å›¾
             torch.autograd.grad(loss, feature_maps[counter])[0]  â­ Ã— æ¢¯åº¦
            ).abs().sum(1)
    threshold = torch.kthvalue(count, ...)
    mask[count > threshold] = 1
```

**è°ƒç”¨ä½ç½®ï¼š**
```
main_imp_fillback.py:332-333 (Refillæ¨¡å¼)
main_imp_fillback.py:337-338 (RSSTæ¨¡å¼ï¼Œreturn_mask_only=True)
```

### 2.4 RSSTç®—æ³•ä¸‰å¤§å…³é”®å‡½æ•°

#### ğŸ”´ å‡½æ•°1ï¼šupdate_reg() - æ›´æ–°æ­£åˆ™åŒ–å¼ºåº¦
ğŸ“ **æ–‡ä»¶ï¼š** `main_imp_fillback.py`
ğŸ“ **è¡Œå·ï¼š** 353-404

```python
def update_reg(passer, pruner, model, state, i, j):
    # ç¬¬360-365è¡Œ: æ‰¾å‡ºéœ€è¦æ­£åˆ™åŒ–çš„æƒé‡
    refill_mask = passer.refill_mask[name].flatten()
    current_mask = passer.current_mask[name + '.weight_mask'].flatten()
    unpruned_indices = torch.where(
        (refill_mask == 0) & (current_mask == 1)  # â­ å½“å‰ä¿ç•™ä½†ä¸é‡è¦çš„æƒé‡
    )
    
    # ç¬¬367-404è¡Œ: æ ¹æ®scheduleæ›´æ–°lambda
    if args.RST_schedule == 'x':
        pruner.reg[name][unpruned_indices_np] += args.reg_granularity_prune  # çº¿æ€§
    elif args.RST_schedule == 'exp_custom_exponents':
        weight_start = (1/(e-1)) * args.reg_granularity_prune * \
                       (exp((i+1)**args.exponents / j**args.exponents) - 1)  # â­ æŒ‡æ•°
        pruner.reg[name][unpruned_indices_np] = weight_start
```

**è°ƒç”¨ä½ç½®ï¼š**
```
main_imp_fillback.py:432
    if state > 0 and args.struct == 'rsst':
        if args.reg_granularity_prune * i < 1:
            update_reg(passer, pruner, model, state, i, j)  â­ æ¯ä¸ªbatchè°ƒç”¨
```

#### ğŸ”´ å‡½æ•°2ï¼šapply_reg() - åº”ç”¨æ­£åˆ™åŒ–åˆ°æ¢¯åº¦
ğŸ“ **æ–‡ä»¶ï¼š** `main_imp_fillback.py`
ğŸ“ **è¡Œå·ï¼š** 458-483

```python
def apply_reg(pruner, model, passer):
    for name, m in model.named_modules():
        if name in pruner.reg:
            # ç¬¬465-466è¡Œ: è·å–æ­£åˆ™åŒ–å¼ºåº¦å¹¶è°ƒæ•´å½¢çŠ¶
            reg = pruner.reg[name]
            reg = reg.view_as(m.weight.data)  # [N, C, H, W]
            
            # ç¬¬473è¡Œ: è®¡ç®—L2æ­£åˆ™åŒ–æ¢¯åº¦
            l2_grad = reg * m.weight  # â­ grad = lambda * w
            
            # ç¬¬476-481è¡Œ: æ·»åŠ åˆ°åŸæ¢¯åº¦æˆ–æ›¿æ¢
            if passer.args.block_loss_grad:
                m.weight.grad = l2_grad  # ä»…ç”¨æ­£åˆ™åŒ–æ¢¯åº¦
            else:
                m.weight.grad += l2_grad  # â­ åŠ åˆ°åŸæ¢¯åº¦ä¸Š
```

**è°ƒç”¨ä½ç½®ï¼š**
```
main_imp_fillback.py:434
    if state > 0 and args.struct == 'rsst':
        model = apply_reg(pruner, model, passer)  â­ æ¯ä¸ªbatchè°ƒç”¨
```

#### ğŸ”´ å‡½æ•°3ï¼štrain() - è®­ç»ƒå¾ªç¯
ğŸ“ **æ–‡ä»¶ï¼š** `main_imp_fillback.py`
ğŸ“ **è¡Œå·ï¼š** 406-457

```python
def train(state, train_loader, model, criterion, optimizer, epoch, passer, pruner):
    for i, (image, target) in enumerate(train_loader):
        j = len(train_loader)
        
        # ç¬¬425-426è¡Œ: å‰å‘+åå‘
        output_clean = model(image)
        loss = criterion(output_clean, target)
        optimizer.zero_grad()
        loss.backward()
        
        # ç¬¬429-434è¡Œ: RSSTå…³é”®æ­¥éª¤
        if state > 0 and args.struct == 'rsst':
            if passer.args.reg_granularity_prune * i < 1:
                update_reg(passer, pruner, model, state, i, j)  # â­ æ­¥éª¤1
            model = apply_reg(pruner, model, passer)  # â­ æ­¥éª¤2
        
        # ç¬¬435è¡Œ: å‚æ•°æ›´æ–°
        optimizer.step()
```

**è°ƒç”¨ä½ç½®ï¼š**
```
main_imp_fillback.py:232 (RSSTæ¨¡å¼)
main_imp_fillback.py:234 (Refillæ¨¡å¼)
```

### 2.5 æ­£åˆ™åŒ–åæƒé‡é‡ç½®
ğŸ“ **æ–‡ä»¶ï¼š** `main_imp_fillback.py`
ğŸ“ **è¡Œå·ï¼š** 270-305

```python
# ç¬¬271è¡Œ: ä»…åœ¨RSSTæ¨¡å¼ä¸”state>0æ—¶æ‰§è¡Œ
if state > 0 and passer.args.struct == 'rsst':
    # ç¬¬288-305è¡Œ: éå†æ‰€æœ‰å·ç§¯å±‚
    for i, (name, m) in enumerate(model.named_modules()):
        if isinstance(m, nn.Conv2d):
            if name != 'conv1':
                mask = passer.current_mask[name + '.weight_mask']
                
                # ç¬¬302è¡Œ: â­ å°†æƒé‡é‡ç½®ä¸ºåˆå§‹å€¼
                m.weight.data = initialization[name + ".weight"]
                
                # ç¬¬305è¡Œ: é‡æ–°åº”ç”¨mask
                prune.CustomFromMask.apply(m, 'weight', mask=mask)
```

**ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸€æ­¥ï¼Ÿ**
- æ­£åˆ™åŒ–ä½¿æƒé‡è¶‹å‘äº0
- é‡ç½®æƒé‡ä¸ºåˆå§‹å€¼ï¼Œå‡†å¤‡ä¸‹ä¸€è½®å‰ªæ
- ç¬¦åˆLottery Ticket Hypothesis

---

## ğŸ¨ ä¸‰ã€æ•°æ®æµç¨‹å›¾

### 3.1 æ•´ä½“æµç¨‹
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ main_imp_fillback.py:main()                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 102è¡Œ: åˆå§‹åŒ–æ¨¡å‹ â”‚  â† utils.py:setup_model_dataset()
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 131è¡Œ: ä¿å­˜åˆå§‹æƒé‡â”‚  initialization = model.state_dict()
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 209è¡Œ: for state in range(20): â”‚  è¿­ä»£å‰ªæ20æ¬¡
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ç¬¬1é˜¶æ®µ: è®­ç»ƒ         â”‚
        â”‚ 225-268è¡Œ: 120 epochsâ”‚
        â”‚   â”œâ”€ train()         â”‚
        â”‚   â”œâ”€ validate()      â”‚
        â”‚   â””â”€ scheduler.step()â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ç¬¬2é˜¶æ®µ: å‰ªæ         â”‚
        â”‚ 321è¡Œ: pruning_model()â”‚  â† pruning_utils.py:6-22
        â”‚ 324è¡Œ: extract_mask() â”‚  â† pruning_utils.py:53-58
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ç¬¬3é˜¶æ®µ: ç®—æ³•åˆ†æ”¯          â”‚
        â”‚ 330-343è¡Œ                  â”‚
        â”‚  â”œâ”€ Refill: æ¢å¤éƒ¨åˆ†æƒé‡   â”‚
        â”‚  â””â”€ RSST: æ ‡è®°å¾…æ­£åˆ™åŒ–æƒé‡ â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ 328è¡Œ: é‡ç½®ä¸ºåˆå§‹æƒé‡ â”‚  model.load_state_dict(initialization)
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â””â”€â”€â”€ å¾ªç¯åˆ°ä¸‹ä¸€ä¸ªstate
```

### 3.2 RSSTè¯¦ç»†æµç¨‹
```
State 0:
  â””â”€ æ­£å¸¸è®­ç»ƒï¼Œä¸åº”ç”¨æ­£åˆ™åŒ–

State 1+:
  â”œâ”€ 224è¡Œ: pruner = reg_pruner.Pruner(model, args, passer)
  â”‚
  â”œâ”€ æ¯ä¸ªepochçš„æ¯ä¸ªbatch:
  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚   â”‚ train() [406-457è¡Œ]      â”‚
  â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚   â”‚ 1. forward + backward    â”‚
  â”‚   â”‚ 2. update_reg()          â”‚  â† 353-404è¡Œ
  â”‚   â”‚    â””â”€ è®¡ç®—unpruned_indicesâ”‚
  â”‚   â”‚    â””â”€ æ›´æ–°lambdaå€¼        â”‚
  â”‚   â”‚ 3. apply_reg()           â”‚  â† 458-483è¡Œ
  â”‚   â”‚    â””â”€ grad += lambda*w   â”‚
  â”‚   â”‚ 4. optimizer.step()      â”‚
  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â””â”€ è®­ç»ƒå:
      â””â”€ 270-305è¡Œ: å°†æ­£åˆ™åŒ–çš„æƒé‡é‡ç½®ä¸ºåˆå§‹å€¼
```

### 3.3 maskä¼ é€’æµç¨‹
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pruning_model(model, rate)      â”‚  ç¬¬321è¡Œ
â”‚ â””â”€ åœ¨modelä¸­åˆ›å»ºweight_mask     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ current_mask = extract_mask()   â”‚  ç¬¬324è¡Œ
â”‚ â””â”€ æå–æ‰€æœ‰ *.weight_mask       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ passer.current_mask = current_maskâ”‚  ç¬¬325è¡Œ
â”‚ â””â”€ ä¼ é€’ç»™passerå¯¹è±¡             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ mask = prune_model_custom_fillback()    â”‚  ç¬¬337è¡Œ
â”‚ â””â”€ åŸºäºcriteriaè®¡ç®—æ–°mask               â”‚
â”‚    (åªæ ‡è®°ï¼Œä¸å®é™…å‰ªæ)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ passer.refill_mask = mask       â”‚  ç¬¬341è¡Œ
â”‚ â””â”€ ä¼ é€’ç»™passerå¯¹è±¡             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ update_reg(passer, pruner, ...)       â”‚  ç¬¬432è¡Œ
â”‚ â””â”€ æ‰¾å‡º current_mask=1 ä¸” refill_mask=0â”‚
â”‚    çš„æƒé‡ï¼Œå¯¹å…¶åº”ç”¨æ­£åˆ™åŒ–              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š å››ã€å‚æ•°å½±å“é€ŸæŸ¥è¡¨

### 4.1 å‰ªæç‡è®¡ç®—
ç»è¿‡ `n` æ¬¡è¿­ä»£å‰ªæåçš„æ€»å‰©ä½™ç‡ï¼š

```
ç¬¬1æ¬¡å‰ªæå: 1 - 0.2 = 0.8 (80%)
ç¬¬2æ¬¡å‰ªæå: 0.8 Ã— (1 - 0.2) = 0.64 (64%)
ç¬¬3æ¬¡å‰ªæå: 0.64 Ã— (1 - 0.2) = 0.512 (51.2%)
...
ç¬¬næ¬¡å‰ªæå: (1 - rate)^n
```

**é»˜è®¤é…ç½®** (20æ¬¡, rate=0.2):
```
æœ€ç»ˆå‰©ä½™ç‡ = (1 - 0.2)^20 = 0.8^20 â‰ˆ 0.0115 (1.15%)
```

### 4.2 æ­£åˆ™åŒ–Scheduleå¯¹æ¯”

#### çº¿æ€§ (x)
```python
lambda[k] = lambda_0 + k * delta
```
| Batch | 0 | 100 | 200 | 300 |
|-------|---|-----|-----|-----|
| Î»     | 0 | 100 | 200 | 300 |

#### æŒ‡æ•° (exp)
```python
lambda[k] = exp(lambda_0 + k * delta)
```
| Batch | 0 | 100 | 200 | 300 |
|-------|---|-----|-----|-----|
| Î»     | 1 | e^100 | e^200 | e^300 |

#### è‡ªå®šä¹‰æŒ‡æ•° (exp_custom_exponents, exponents=4)
```python
lambda[k] = (1/(e-1)) * delta * (exp((k+1)^4 / K^4) - 1)
```
| Batch | 0/390 | 100/390 | 200/390 | 300/390 |
|-------|-------|---------|---------|---------|
| Î»     | 0.000 | 0.001   | 0.058   | 0.515   |

### 4.3 criteriaå¯¹æ¯”

| Criteria | è®¡ç®—å…¬å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåœºæ™¯ |
|---------|---------|------|------|---------|
| `remain` | maskä¸­1çš„æ•°é‡ | ç®€å•å¿«é€Ÿ | ä¸è€ƒè™‘å®é™…é‡è¦æ€§ | åŸºçº¿ |
| `magnitude` | Î£\|weight\| | ç»å…¸æ–¹æ³• | é™æ€è¯„ä¼° | é€šç”¨ |
| `l1` | Î£\|activation\| | è€ƒè™‘å®é™…æ¿€æ´» | éœ€å‰å‘ä¼ æ’­ | **æ¨è** |
| `l2` | Î£activationÂ² | è€ƒè™‘èƒ½é‡ | å¯¹å¼‚å¸¸å€¼æ•æ„Ÿ | ç¨³å®šåœºæ™¯ |
| `saliency` | Î£\|activationÃ—grad\| | è€ƒè™‘æ¢¯åº¦ä¿¡æ¯ | è®¡ç®—æ˜‚è´µ | ç²¾ç»†å‰ªæ |

---

## ğŸ› ï¸ äº”ã€è°ƒè¯•æŠ€å·§

### 5.1 æ‰“å°maskä¿¡æ¯
åœ¨ `main_imp_fillback.py` ç¬¬324è¡Œåæ·»åŠ ï¼š

```python
current_mask = extract_mask(model.state_dict())
passer.current_mask = current_mask

# æ·»åŠ è°ƒè¯•ä»£ç  â­
for name in current_mask:
    mask = current_mask[name]
    sparsity = (mask == 0).float().mean()
    print(f"Layer {name}: sparsity = {sparsity:.2%}, shape = {mask.shape}")
```

### 5.2 æ‰“å°æ­£åˆ™åŒ–å¼ºåº¦
åœ¨ `main_imp_fillback.py` ç¬¬434è¡Œåæ·»åŠ ï¼š

```python
model = apply_reg(pruner, model, passer)

# æ·»åŠ è°ƒè¯•ä»£ç  â­
if i % 100 == 0:  # æ¯100ä¸ªbatchæ‰“å°ä¸€æ¬¡
    for name in pruner.reg:
        reg = pruner.reg[name]
        print(f"{name}: lambda_min={reg.min():.4f}, lambda_max={reg.max():.4f}, lambda_mean={reg.mean():.4f}")
```

### 5.3 å¯è§†åŒ–mask
ä½¿ç”¨ `plot_mask.py` æˆ–æ·»åŠ åˆ°è®­ç»ƒå¾ªç¯ï¼š

```python
import matplotlib.pyplot as plt

def visualize_mask(mask_dict, save_path='mask_viz.png'):
    fig, axes = plt.subplots(4, 4, figsize=(12, 12))
    for idx, (name, mask) in enumerate(list(mask_dict.items())[:16]):
        ax = axes[idx // 4, idx % 4]
        mask_2d = mask.cpu().numpy().reshape(mask.shape[0], -1)
        ax.imshow(mask_2d, cmap='binary', aspect='auto')
        ax.set_title(name.split('.')[0])
    plt.tight_layout()
    plt.savefig(save_path)
```

### 5.4 æ£€æŸ¥å‰ªææ•ˆæœ
åœ¨ `main_imp_fillback.py` ç¬¬321è¡Œåæ·»åŠ ï¼š

```python
remain_before = check_sparsity(model, conv1=False)
pruning_model(model, args.rate, conv1=False)
remain_after = check_sparsity(model, conv1=False)

# æ·»åŠ è°ƒè¯•ä»£ç  â­
print(f"å‰ªæå‰: {remain_before:.2f}%")
print(f"å‰ªæå: {remain_after:.2f}%")
print(f"å®é™…å‰ªæ‰: {remain_before - remain_after:.2f}%")
```

---

## ğŸ“Œ å…­ã€å¸¸è§é”™è¯¯ä½ç½®

### é”™è¯¯1ï¼šmaskå½¢çŠ¶ä¸åŒ¹é…
**ä½ç½®ï¼š** `main_imp_fillback.py` ç¬¬362è¡Œ

```python
# åŸå› ï¼šrefill_mask å’Œ current_mask å½¢çŠ¶ä¸ä¸€è‡´
refill_mask = passer.refill_mask[name].flatten()
current_mask = passer.current_mask[name + '.weight_mask'].flatten()

# è§£å†³ï¼šæ£€æŸ¥ç»´åº¦
if refill_mask.shape != current_mask.shape:
    raise ValueError(f"Shape mismatch: {refill_mask.shape} vs {current_mask.shape}")
```

### é”™è¯¯2ï¼šæ­£åˆ™åŒ–æœªåˆå§‹åŒ–
**ä½ç½®ï¼š** `main_imp_fillback.py` ç¬¬224è¡Œ

```python
# åŸå› ï¼šstate=0æ—¶pruneræœªåˆå§‹åŒ–
if state > 0 and passer.args.struct == 'rsst':
    pruner = reg_pruner.Pruner(model, args, passer)

# ç¡®ä¿åœ¨train()ä¸­æ£€æŸ¥
if state > 0 and args.struct == 'rsst':
    assert pruner is not None, "Pruner not initialized!"
```

### é”™è¯¯3ï¼šnormalizeå±‚ç¼ºå¤±
**ä½ç½®ï¼š** `main_imp_fillback.py` ç¬¬138-139è¡Œ

```python
# åŸå› ï¼šæŸäº›checkpointä¸åŒ…å«normalizeå±‚å‚æ•°
initialization['normalize.mean'] = new_initialization['normalize.mean']
initialization['normalize.std'] = new_initialization['normalize.std']

# è§£å†³ï¼šå§‹ç»ˆä»å½“å‰æ¨¡å‹å¤åˆ¶
```

---

## ğŸ“ ä¸ƒã€ä»£ç é˜…è¯»è·¯å¾„å»ºè®®

### æ–°æ‰‹è·¯å¾„ï¼ˆç†è§£åŸºæœ¬å‰ªæï¼‰
```
1. main_imp_fillback.py:83-93     (å‘½ä»¤è¡Œå‚æ•°)
2. main_imp_fillback.py:102       (æ¨¡å‹åˆå§‹åŒ–)
3. main_imp_fillback.py:209-268   (ä¸»å¾ªç¯ç»“æ„)
4. pruning_utils.py:6-22          (L1å‰ªæ)
5. main_imp_fillback.py:321-328   (å‰ªæ+é‡ç½®)
```

### è¿›é˜¶è·¯å¾„ï¼ˆç†è§£Refillï¼‰
```
1. æ–°æ‰‹è·¯å¾„ 1-5
2. pruning_utils.py:77-243        (Refillå®Œæ•´å®ç°)
3. main_imp_fillback.py:330-333   (Refillè°ƒç”¨)
4. pruning_utils.py:190-201       (L1 criteria)
5. pruning_utils.py:175-188       (magnitude criteria)
```

### é«˜çº§è·¯å¾„ï¼ˆç†è§£RSSTï¼‰
```
1. è¿›é˜¶è·¯å¾„ 1-5
2. main_imp_fillback.py:334-341   (RSSTåˆå§‹åŒ–)
3. main_imp_fillback.py:353-404   (update_regå‡½æ•°)
4. main_imp_fillback.py:458-483   (apply_regå‡½æ•°)
5. main_imp_fillback.py:406-457   (trainå‡½æ•°é›†æˆ)
6. main_imp_fillback.py:270-305   (æƒé‡é‡ç½®æœºåˆ¶)
7. reg_pruner_files/reg_pruner.py (Prunerç±»å®ç°)
```

### ç ”ç©¶è·¯å¾„ï¼ˆæ·±å…¥ç®—æ³•ç»†èŠ‚ï¼‰
```
1. é«˜çº§è·¯å¾„ 1-7
2. reg_pruner_files/meta_pruner.py (åŸºç±»å®ç°)
3. pruning_utils.py:270-295       (SNIPç®—æ³•)
4. pruning_utils.py:346-393       (GraSPç®—æ³•)
5. pruning_utils.py:297-344       (SynFlowç®—æ³•)
6. permute_masks.py               (maskæ’åˆ—ä¼˜åŒ–)
```

---

## ğŸ” å…«ã€å¿«é€Ÿå®šä½è¡¨

éœ€è¦ä¿®æ”¹æŸä¸ªåŠŸèƒ½ï¼Ÿç›´æ¥è·³åˆ°å¯¹åº”ä½ç½®ï¼š

| éœ€æ±‚ | æ–‡ä»¶ | è¡Œå· | å‡½æ•°/å˜é‡ |
|-----|------|------|----------|
| æ›´æ¢æ¨¡å‹ | utils.py | 92-94 | `setup_model_dataset()` |
| è°ƒæ•´å‰ªæç‡ | main_imp_fillback.py | 65 | `--rate` |
| ä¿®æ”¹è®­ç»ƒè½®æ•° | main_imp_fillback.py | 58 | `--epochs` |
| æ”¹å˜æ­£åˆ™åŒ–schedule | main_imp_fillback.py | 396-404 | `update_reg()` |
| ä¿®æ”¹criteria | pruning_utils.py | 160-226 | `prune_model_custom_fillback()` |
| è°ƒæ•´å­¦ä¹ ç‡ | main_imp_fillback.py | 55 | `--lr` |
| æ”¹å˜æ•°æ®é›† | dataset.py | 63-83 | `cifar100_dataloaders()` |
| æ·»åŠ æ—¥å¿— | main_imp_fillback.py | 242 | `wandb.log()` |

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**æœ€åæ›´æ–°ï¼š** 2026-01-05  
**é€‚ç”¨ç‰ˆæœ¬ï¼š** RSST-master

