
# Refill vs RSST æ–¹æ³•æµç¨‹å¯¹æ¯”

## æ•´ä½“æ¶æ„

ä¸¤ç§æ–¹æ³•éƒ½ä½¿ç”¨**è¿­ä»£å¼å‰ªæ**æ¡†æ¶ï¼š
```
for state in range(pruning_times):  # é»˜è®¤20æ¬¡è¿­ä»£
    1. è®­ç»ƒ N ä¸ª epoch
    2. å‰ªææ“ä½œ
    3. éªŒè¯å’Œä¿å­˜
```

---

## ğŸ“‹ è¯¦ç»†æµç¨‹å¯¹æ¯”

### **State 0ï¼ˆåˆå§‹è¿­ä»£ï¼‰**

#### å…±åŒç‚¹ï¼š
1. ä»åˆå§‹åŒ–æƒé‡å¼€å§‹è®­ç»ƒ
2. è®­ç»ƒå®Œæˆåä¿å­˜è®­ç»ƒåçš„æƒé‡ `train_weight`
3. è®¡ç®—é‡è¦æ€§åˆ†æ•°ï¼Œç¡®å®šå“ªäº›æƒé‡éœ€è¦å‰ªæ
4. ç”Ÿæˆå‰ªæmaskï¼ˆ`refill_mask`ï¼‰

#### Refillæ–¹æ³•ï¼š
```python
# 1. è®­ç»ƒæ¨¡å‹ï¼ˆä¸å¸¦æ­£åˆ™åŒ–ï¼‰
for epoch in range(epochs):
    train(model, ...)  # æ­£å¸¸è®­ç»ƒ

# 2. è®¡ç®—maskå¹¶ç›´æ¥å‰ªæ
model = prune_model_custom_fillback_vit_head_and_mlp(
    model, ..., 
    return_mask_only=False)  # â† è¿”å›å·²å‰ªæçš„æ¨¡å‹

# 3. æ¨¡å‹å·²ç»è¢«å‰ªæï¼Œæƒé‡å·²è¢«ç½®é›¶
```

#### RSSTæ–¹æ³•ï¼š
```python
# 1. è®­ç»ƒæ¨¡å‹ï¼ˆä¸å¸¦æ­£åˆ™åŒ–ï¼‰
for epoch in range(epochs):
    train(model, ...)  # æ­£å¸¸è®­ç»ƒ

# 2. è®¡ç®—maskä½†ä¸å‰ªæ
mask = prune_model_custom_fillback_vit_head_and_mlp(
    model, ..., 
    return_mask_only=True)  # â† åªè¿”å›maskï¼Œä¸å‰ªæ

# 3. ä¿å­˜maskåˆ°passerï¼Œæ¨¡å‹æƒé‡ä¿æŒå®Œæ•´
passer.refill_mask = mask
```

---

### **State > 0ï¼ˆåç»­è¿­ä»£ï¼‰**

#### Refillæ–¹æ³•ï¼š
```python
# æ¯æ¬¡è¿­ä»£å¼€å§‹ï¼š
# 1. é‡æ–°è®¡ç®—maskå¹¶å‰ªæ
model = prune_model_custom_fillback_vit_head_and_mlp(
    model, ..., 
    return_mask_only=False)

# 2. è®­ç»ƒå·²å‰ªæçš„æ¨¡å‹ï¼ˆä¸å¸¦æ­£åˆ™åŒ–ï¼‰
for epoch in range(epochs):
    train(model, ...)  # å‰ªæåçš„æƒé‡ä¿æŒä¸º0

# ç‰¹ç‚¹ï¼š
# - ç›´æ¥å‰ªæï¼ˆä¸€åˆ€åˆ‡ï¼‰
# - è®­ç»ƒè¿‡ç¨‹ä¸­ä¸ä½¿ç”¨æ­£åˆ™åŒ–
# - è¢«å‰ªæçš„æƒé‡å§‹ç»ˆä¿æŒä¸º0
```

#### RSSTæ–¹æ³•ï¼š
```python
# æ¯æ¬¡è¿­ä»£å¼€å§‹ï¼š
# 1. åˆå§‹åŒ–Prunerï¼ˆæ­£åˆ™åŒ–å™¨ï¼‰
pruner = reg_pruner.Pruner(model, args, passer)

# 2. è®­ç»ƒæ—¶ä½¿ç”¨L2æ­£åˆ™åŒ–é€æ¸å‹ç¼©æƒé‡
for epoch in range(epochs):
    for batch in train_loader:
        # å‰å‘ä¼ æ’­
        output = model(input)
        loss = criterion(output, target)
        
        # â­ æ·»åŠ L2æ­£åˆ™åŒ–æƒ©ç½š
        for name, param in model.named_parameters():
            if name in pruner.reg:
                # å¯¹éœ€è¦å‰ªæçš„æƒé‡æ·»åŠ L2æƒ©ç½š
                reg_loss = (pruner.reg[name] * param.flatten()**2).sum()
                loss += reg_loss
        
        # åå‘ä¼ æ’­
        loss.backward()
        optimizer.step()
        
        # â­ æ¯ä¸ªbatchåæ›´æ–°æ­£åˆ™åŒ–ç³»æ•°ï¼ˆé€æ¸å¢å¤§ï¼‰
        update_reg(passer, pruner, model, state, i, j)
        # pruner.reg[name][indices] += reg_granularity_prune
        # æ­£åˆ™åŒ–ç³»æ•°æŒ‰ç…§æŒ‡æ•°/å¤šé¡¹å¼å¢é•¿

# 3. è®­ç»ƒç»“æŸåæ‰çœŸæ­£åº”ç”¨å‰ªæ
for name, m in model.named_modules():
    m.weight.data = initialization[name + ".weight"]  # æ¢å¤åˆå§‹æƒé‡
    prune.CustomFromMask.apply(m, 'weight', mask)     # åº”ç”¨mask

# ç‰¹ç‚¹ï¼š
# - æ¸è¿›å¼å‰ªæï¼ˆé€šè¿‡æ­£åˆ™åŒ–é€æ¸å‹ç¼©ï¼‰
# - æ­£åˆ™åŒ–ç³»æ•°åŠ¨æ€å¢é•¿
# - è®­ç»ƒè¿‡ç¨‹ä¸­æƒé‡é€æ¸è¶‹è¿‘äº0
# - æœ€åæ‰çœŸæ­£ç½®é›¶
```

---

## ğŸ” å…³é”®åŒºåˆ«æ€»ç»“

| ç»´åº¦ | Refill | RSST |
|------|--------|------|
| **å‰ªææ—¶æœº** | ç«‹å³å‰ªæï¼ˆè®­ç»ƒå‰ï¼‰ | å»¶è¿Ÿå‰ªæï¼ˆè®­ç»ƒåï¼‰ |
| **è®­ç»ƒè¿‡ç¨‹** | è®­ç»ƒå·²å‰ªæçš„ç¨€ç–æ¨¡å‹ | è®­ç»ƒç¨ å¯†æ¨¡å‹+æ­£åˆ™åŒ– |
| **æ­£åˆ™åŒ–** | âŒ ä¸ä½¿ç”¨ | âœ… ä½¿ç”¨L2æ­£åˆ™åŒ– |
| **æƒé‡å˜åŒ–** | è¢«å‰ªææƒé‡=0ï¼ˆå›ºå®šï¼‰ | è¢«å‰ªææƒé‡é€æ¸â†’0 |
| **maskä½œç”¨** | ç›´æ¥åº”ç”¨ï¼Œç¡¬æ€§çº¦æŸ | è½¯æ€§å¼•å¯¼ï¼ˆé€šè¿‡æ­£åˆ™åŒ–ï¼‰ |
| **è®¡ç®—å¼€é”€** | è¾ƒå°ï¼ˆç¨€ç–è®¡ç®—ï¼‰ | è¾ƒå¤§ï¼ˆç¨ å¯†è®¡ç®—+æ­£åˆ™åŒ–ï¼‰ |
| **å‰ªæç­–ç•¥** | ç¡¬å‰ªæï¼ˆHard Pruningï¼‰ | è½¯å‰ªæï¼ˆSoft Pruningï¼‰ |

---

## âš™ï¸ æ­£åˆ™åŒ–æ›´æ–°æœºåˆ¶ï¼ˆRSSTç‰¹æœ‰ï¼‰

```python
def update_reg(passer, pruner, model, state, i, j):
    """æ¯ä¸ªbatchåè°ƒç”¨ï¼Œé€æ¸å¢å¤§æ­£åˆ™åŒ–å¼ºåº¦"""
    
    for name, m in model.named_modules():
        # æ‰¾åˆ°éœ€è¦å‰ªæä½†è¿˜æœªå‰ªæçš„æƒé‡ç´¢å¼•
        refill_mask = passer.refill_mask[name]    # 0=éœ€è¦å‰ªæ
        current_mask = passer.current_mask[name]  # 1=å½“å‰ä¿ç•™
        unpruned_indices = torch.where((refill_mask == 0) & (current_mask == 1))
        
        # æ›´æ–°æ­£åˆ™åŒ–ç³»æ•°ï¼ˆæŒ‰ç…§scheduleå¢é•¿ï¼‰
        if args.RST_schedule == 'x':
            pruner.reg[name][indices] += reg_granularity_prune
        
        elif args.RST_schedule == 'exp_custom_exponents':
            # æŒ‡æ•°å¢é•¿: Î» = base * (e^(step/warmup))^exponent
            pruner.reg[name][indices] = base * (math.exp(step/warmup)) ** exponent
```

**æ­£åˆ™åŒ–å¢é•¿æ›²çº¿ç¤ºä¾‹**ï¼š
```
Epoch 0:  Î» = 0.00001
Epoch 5:  Î» = 0.0001
Epoch 10: Î» = 0.001
Epoch 15: Î» = 0.01
...
```
æ­£åˆ™åŒ–å¼ºåº¦é€æ¸å¢å¤§ â†’ å¯¹åº”æƒé‡é€æ¸è¢«å‹ç¼©åˆ°æ¥è¿‘0

---

## ğŸ“Š æµ‹è¯•æ—¶é—´æµç¨‹ä¸€è‡´æ€§

**ä½ ä¹‹å‰çš„é€Ÿåº¦æµ‹è¯•ä½¿ç”¨çš„é…ç½®**ï¼š
```bash
--struct rsst
--pruning_times 20
--epochs 1
--vit_prune_target both
--vit_structured True
```

**æµ‹è¯•çš„æµç¨‹**ï¼š
1. State 0: è®­ç»ƒ1ä¸ªepochï¼ˆä¸å¸¦æ­£åˆ™åŒ–ï¼‰â†’ è®¡ç®—mask
2. State 1-19: æ¯æ¬¡è®­ç»ƒ1ä¸ªepochï¼ˆå¸¦æ­£åˆ™åŒ–ï¼‰â†’ æ›´æ–°æ­£åˆ™åŒ–ç³»æ•°

**ä¸æ­£å¼å®éªŒçš„ä¸€è‡´æ€§**ï¼š
- âœ… **æµç¨‹ä¸€è‡´**ï¼šéƒ½æ˜¯è¿­ä»£å¼è®­ç»ƒ+å‰ªæ
- âœ… **RSSTé€»è¾‘ä¸€è‡´**ï¼šéƒ½ä½¿ç”¨æ­£åˆ™åŒ–å‹ç¼©æƒé‡
- âš ï¸ **åŒºåˆ«**ï¼šæµ‹è¯•åªæœ‰1ä¸ªepoch/iterationï¼Œæ­£å¼å®éªŒå¯èƒ½æœ‰æ›´å¤šepoch

**æ—¶é—´å¯¹æ¯”ï¼ˆä»¥RSSTä¸ºä¾‹ï¼‰**ï¼š
```
æµ‹è¯•é…ç½®ï¼ˆepochs=1ï¼‰ï¼š
- 1ä¸ªiteration = 1ä¸ªepochè®­ç»ƒ + å‰ªææ“ä½œ â‰ˆ 2åˆ†é’Ÿ
- 20ä¸ªiterations â‰ˆ 40åˆ†é’Ÿ

å¦‚æœepochs=40ï¼ˆæ­£å¼å®éªŒï¼‰ï¼š
- 1ä¸ªiteration = 40ä¸ªepochè®­ç»ƒ + å‰ªææ“ä½œ â‰ˆ 60åˆ†é’Ÿ
- 20ä¸ªiterations â‰ˆ 20å°æ—¶
```

---

## ğŸ“ æ€»ç»“

1. **Refillæ˜¯"ç¡¬å‰ªæ"**ï¼šç›´æ¥æŠŠä¸é‡è¦çš„æƒé‡ç½®é›¶ï¼Œç„¶åè®­ç»ƒç¨€ç–æ¨¡å‹
2. **RSSTæ˜¯"è½¯å‰ªæ"**ï¼šé€šè¿‡æ­£åˆ™åŒ–é€æ¸å‹ç¼©æƒé‡ï¼Œæœ€åæ‰çœŸæ­£ç½®é›¶
3. **æµ‹è¯•æµç¨‹ä¸æ­£å¼å®éªŒä¸€è‡´**ï¼Œåªæ˜¯epochæ•°é‡ä¸åŒ
4. **RSSTæ›´æ…¢**ï¼šå› ä¸ºæ¯ä¸ªbatchéƒ½è¦è®¡ç®—æ­£åˆ™åŒ–æŸå¤±å¹¶æ›´æ–°æ­£åˆ™åŒ–ç³»æ•°

