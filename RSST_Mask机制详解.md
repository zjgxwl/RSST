# RSST Maskæœºåˆ¶è¯¦è§£

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

**Q: `current_mask` å’Œ `refill_mask` æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

**ç®€ç­”**ï¼š
- **`current_mask`**ï¼šå½“å‰æ¨¡å‹çš„å‰ªæçŠ¶æ€ï¼ˆL1å…¨å±€å‰ªæçš„ç»“æœï¼‰
- **`refill_mask`**ï¼šé‡ç»„åçš„maskï¼ŒæŒ‡å¯¼ä¸‹ä¸€æ¬¡è¿­ä»£çš„æ­£åˆ™åŒ–ç›®æ ‡

**å…³é”®ä»£ç **ï¼ˆ`main_imp_fillback.py:565`ï¼‰ï¼š
```python
unpruned_indices = torch.where((refill_mask == 0) & (current_mask == 1))
```

è¿™è¡Œä»£ç æ‰¾å‡ºï¼š**å½“å‰è¿˜ä¿ç•™ï¼ˆcurrent_mask=1ï¼‰ï¼Œä½†æœªæ¥åº”è¯¥è¢«å‰ªæï¼ˆrefill_mask=0ï¼‰çš„æƒé‡**

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## ğŸ“Š è¯¦ç»†å›¾è§£

### è¿­ä»£Nçš„å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤1: è®­ç»ƒï¼ˆ80 epochsï¼Œå¸¦æ­£åˆ™åŒ–ï¼‰                          â”‚
â”‚                                                               â”‚
â”‚   for batch in train_loader:                                 â”‚
â”‚       loss.backward()                                         â”‚
â”‚       update_reg()  # å¯¹ unpruned_indices åº”ç”¨æ­£åˆ™åŒ–        â”‚
â”‚       optimizer.step()                                        â”‚
â”‚                                                               â”‚
â”‚   æ•ˆæœï¼šrefill_mask=0 çš„æƒé‡è¢«é€æ¸å‹ç¼©åˆ°æ¥è¿‘0                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤2: L1å…¨å±€å‰ªæ                                            â”‚
â”‚                                                               â”‚
â”‚   pruning_model(model, rate=0.2)                             â”‚
â”‚                                                               â”‚
â”‚   æ•ˆæœï¼š20%æƒé‡è¢«æ ‡è®°ä¸º0                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤3: æå– current_maskï¼ˆL1å‰ªæçš„ç»“æœï¼‰                    â”‚
â”‚                                                               â”‚
â”‚   current_mask = extract_mask(model.state_dict())            â”‚
â”‚                                                               â”‚
â”‚   ç¤ºä¾‹ï¼š                                                      â”‚
â”‚   current_mask = [1, 0, 1, 1, 0, 1, 1, 1, 0, 1]             â”‚
â”‚                   â†‘  â†‘     â†‘     â†‘  â†‘  â†‘                    â”‚
â”‚                   ä¿ç•™  å‰ªæ  ä¿ç•™  å‰ªæ  ä¿ç•™                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤4: Maské‡ç»„ï¼ˆRSST vs Refillçš„åˆ†æ­§ç‚¹ï¼‰                   â”‚
â”‚                                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  RSSTç®—æ³•        â”‚  Refillç®—æ³•                      â”‚   â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚   â”‚ return_mask_only â”‚ return_mask_only = False        â”‚   â”‚
â”‚   â”‚ = True           â”‚                                  â”‚   â”‚
â”‚   â”‚                  â”‚                                  â”‚   â”‚
â”‚   â”‚ è¿”å›refill_mask  â”‚ ç›´æ¥åº”ç”¨maskåˆ°æ¨¡å‹               â”‚   â”‚
â”‚   â”‚ ç”¨äºæ­£åˆ™åŒ–       â”‚ ï¼ˆæ¢å¤éƒ¨åˆ†æƒé‡ï¼‰                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## ğŸ” ä¸¤ä¸ªMaskçš„è¯¦ç»†å¯¹æ¯”

### ç¤ºä¾‹åœºæ™¯ï¼ˆæŸä¸€å±‚çš„10ä¸ªæƒé‡ï¼‰

**åˆå§‹çŠ¶æ€**ï¼ˆè®­ç»ƒåï¼Œæœªå‰ªæï¼‰ï¼š
```
æƒé‡å€¼:  [0.8, 0.1, 0.5, 0.7, 0.05, 0.6, 0.9, 0.4, 0.02, 0.3]
ç´¢å¼•:     0    1    2    3    4     5    6    7    8     9
```

---

### æ­¥éª¤1: L1å…¨å±€å‰ªæï¼ˆrate=0.2ï¼Œå‰ªæ‰20%ï¼‰

**å‰ªæåæƒé‡**ï¼š
```
æƒé‡å€¼:  [0.8, 0.0, 0.5, 0.7, 0.0, 0.6, 0.9, 0.4, 0.0, 0.3]
         â†“    â†“    â†“    â†“    â†“    â†“    â†“    â†“    â†“    â†“
current_mask = [1, 0, 1, 1, 0, 1, 1, 1, 0, 1]
```

**å«ä¹‰**ï¼š
- `current_mask[i] = 1`ï¼šæƒé‡iå½“å‰ä¿ç•™ï¼ˆ7ä¸ªæƒé‡ï¼‰
- `current_mask[i] = 0`ï¼šæƒé‡iå·²è¢«L1å‰ªææ‰ï¼ˆ3ä¸ªæƒé‡ï¼‰

---

### æ­¥éª¤2: Maské‡ç»„ï¼ˆåŸºäºé‡è¦æ€§criteriaï¼‰

å‡è®¾ä½¿ç”¨`criteria='magnitude'`ï¼ŒæŒ‰æƒé‡ç»å¯¹å€¼é‡æ–°è¯„ä¼°ï¼š

**æƒé‡é‡è¦æ€§æ’åº**ï¼š
```
ç´¢å¼•:     6    0    3    5    2    7    9    1    4    8
æƒé‡:    0.9  0.8  0.7  0.6  0.5  0.4  0.3  0.0  0.0  0.0
é‡è¦æ€§:  é«˜â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ä½
```

**é€‰æ‹©top-70%æƒé‡ä½œä¸º"åº”è¯¥ä¿ç•™"çš„ï¼ˆå‡†ç»“æ„åŒ–å†³ç­–ï¼‰**ï¼š

```python
# å‡è®¾prune_ratio=0.3ï¼Œä¿ç•™70%çš„7ä¸ªæƒé‡ = 5ä¸ªæƒé‡
heads_to_keep = [6, 0, 3, 5, 2]  # æœ€é‡è¦çš„5ä¸ª
```

**ç”Ÿæˆ refill_mask**ï¼š
```
refill_mask = [1, 0, 1, 1, 0, 1, 1, 0, 0, 0]
ç´¢å¼•:          0  1  2  3  4  5  6  7  8  9
```

**å«ä¹‰**ï¼š
- `refill_mask[i] = 1`ï¼šæƒé‡i"åº”è¯¥ä¿ç•™"ï¼ˆ5ä¸ªï¼‰
- `refill_mask[i] = 0`ï¼šæƒé‡i"åº”è¯¥è¢«å‰ªæ"ï¼ˆ5ä¸ªï¼‰

---

### æ­¥éª¤3: æ‰¾å‡ºéœ€è¦æ­£åˆ™åŒ–çš„æƒé‡

**æ ¸å¿ƒé€»è¾‘**ï¼ˆ`update_reg`å‡½æ•°ï¼‰ï¼š

```python
unpruned_indices = torch.where((refill_mask == 0) & (current_mask == 1))
```

**é€ä½åˆ†æ**ï¼š

```
ç´¢å¼•:          0    1    2    3    4    5    6    7    8    9
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
current_mask:  1    0    1    1    0    1    1    1    0    1
refill_mask:   1    0    1    1    0    1    1    0    0    0
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
refill=0:      âœ—    âœ“    âœ—    âœ—    âœ“    âœ—    âœ—    âœ“    âœ“    âœ“
current=1:     âœ“    âœ—    âœ“    âœ“    âœ—    âœ“    âœ“    âœ“    âœ—    âœ“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä¸¤è€…äº¤é›†:      âœ—    âœ—    âœ—    âœ—    âœ—    âœ—    âœ—    âœ“    âœ—    âœ—
              (0)  (1)  (2)  (3)  (4)  (5)  (6)  (7)  (8)  (9)
                                                    â†‘
                                             unpruned_indices = [7]
```

**ç»“æœ**ï¼š
- **`unpruned_indices = [7]`**ï¼šç´¢å¼•7çš„æƒé‡éœ€è¦è¢«æ­£åˆ™åŒ–

**ä¸ºä»€ä¹ˆæ˜¯ç´¢å¼•7ï¼Ÿ**
1. `current_mask[7] = 1`ï¼šå½“å‰è¿˜ä¿ç•™ç€ï¼ˆL1å‰ªææ²¡åˆ æ‰ï¼‰
2. `refill_mask[7] = 0`ï¼šä½†é‡ç»„åè®¤ä¸ºåº”è¯¥è¢«å‰ªæï¼ˆé‡è¦æ€§ä¸å¤Ÿï¼‰
3. **â†’ è¿™ä¸ªæƒé‡åœ¨ä¸‹ä¸€æ¬¡è¿­ä»£ä¸­åº”è¯¥é€šè¿‡æ­£åˆ™åŒ–è¢«å‹ç¼©åˆ°æ¥è¿‘0**

---

### æ­¥éª¤4: åº”ç”¨æ­£åˆ™åŒ–ï¼ˆRSSTç®—æ³•ï¼‰

```python
# å¯¹ unpruned_indices çš„æƒé‡åº”ç”¨L2æ­£åˆ™åŒ–
pruner.reg[name][unpruned_indices] = lambda_value

# åœ¨è®­ç»ƒæ—¶ï¼Œæ¢¯åº¦æ›´æ–°ä¼šé¢å¤–åŠ ä¸Šæ­£åˆ™åŒ–é¡¹
weight.grad += lambda * weight  # L2æ­£åˆ™åŒ–
```

**æ•ˆæœ**ï¼š
- æƒé‡[7]çš„å€¼ï¼ˆ0.4ï¼‰ä¼šè¢«é€æ¸å‹ç¼©
- ç»è¿‡80 epochsè®­ç»ƒåï¼Œæƒé‡[7]å¯èƒ½å˜æˆ0.1, 0.05, 0.01...
- åœ¨ä¸‹ä¸€æ¬¡è¿­ä»£çš„L1å‰ªæä¸­ï¼Œæƒé‡[7]ä¼šæ›´å®¹æ˜“è¢«å‰ªæ‰

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## ğŸ”„ RSST vs Refill å¯¹æ¯”

### RSSTç®—æ³•æµç¨‹

```python
# æ­¥éª¤1-3ï¼šç›¸åŒï¼ˆè®­ç»ƒ â†’ L1å‰ªæ â†’ æå–current_maskï¼‰

# æ­¥éª¤4ï¼šç”Ÿæˆrefill_maskï¼Œä½†ä¸ç«‹å³åº”ç”¨
mask = prune_model_custom_fillback_vit_by_head(
    model, 
    mask_dict=current_mask,
    criteria='magnitude',
    return_mask_only=True  # ğŸ”‘ å…³é”®ï¼šåªè¿”å›mask
)
passer.refill_mask = mask  # ä¿å­˜ç”¨äºæ­£åˆ™åŒ–

# æ­¥éª¤5ï¼šä¸‹ä¸€æ¬¡è¿­ä»£
#   - è®­ç»ƒæ—¶è°ƒç”¨ update_reg()
#   - å¯¹ (refill_mask=0 & current_mask=1) çš„æƒé‡åº”ç”¨æ­£åˆ™åŒ–
#   - è¿™äº›æƒé‡é€æ¸è¢«å‹ç¼©åˆ°æ¥è¿‘0
```

**ç‰¹ç‚¹**ï¼š
- âœ“ ä½¿ç”¨æ­£åˆ™åŒ–æ¸è¿›å‹ç¼©
- âœ“ ä¸ç«‹å³è®¾ç½®ä¸º0ï¼ˆ"è½¯å‰ªæ"ï¼‰
- âœ“ å¤šæ¬¡è¿­ä»£ä¸­é€æ¸è°ƒæ•´
- âœ— æŠ¥å‘Šçš„ç¨€ç–åº¦ä¸º0%ï¼ˆæƒé‡æ²¡æœ‰çœŸæ­£ä¸º0ï¼‰

---

### Refillç®—æ³•æµç¨‹

```python
# æ­¥éª¤1-3ï¼šç›¸åŒï¼ˆè®­ç»ƒ â†’ L1å‰ªæ â†’ æå–current_maskï¼‰

# æ­¥éª¤4ï¼šç”Ÿæˆmaskå¹¶ç«‹å³åº”ç”¨åˆ°æ¨¡å‹
model = prune_model_custom_fillback_vit(
    model, 
    mask_dict=current_mask,
    criteria='magnitude',
    fillback_rate=0.1,       # æ¢å¤10%çš„æƒé‡
    return_mask_only=False   # ğŸ”‘ å…³é”®ï¼šç›´æ¥åº”ç”¨mask
)

# æ­¤æ—¶æ¨¡å‹çš„æƒé‡å·²ç»è¢«ä¿®æ”¹ï¼š
#   - é‡è¦çš„è¢«å‰ªææƒé‡è¢«æ¢å¤ï¼ˆæ ¹æ®fillback_rateï¼‰
#   - ä¸é‡è¦çš„ä¿ç•™æƒé‡å¯èƒ½è¢«å‰ªæ‰
#   - æƒé‡è¢«ç›´æ¥è®¾ä¸º0ï¼ˆ"ç¡¬å‰ªæ"ï¼‰

# passer.refill_mask = None  # Refillä¸éœ€è¦refill_mask
```

**ç‰¹ç‚¹**ï¼š
- âœ“ ç«‹å³è®¾ç½®æƒé‡ä¸º0ï¼ˆ"ç¡¬å‰ªæ"ï¼‰
- âœ“ æŠ¥å‘Šçš„ç¨€ç–åº¦å‡†ç¡®
- âœ“ å¯ä»¥æ¢å¤éƒ¨åˆ†æƒé‡ï¼ˆfillback_rateï¼‰
- âœ— ä¸ä½¿ç”¨æ­£åˆ™åŒ–ï¼ˆä¸€æ¬¡æ€§è°ƒæ•´ï¼‰

---

### å¯¹æ¯”è¡¨æ ¼

| ç‰¹æ€§ | RSST | Refill |
|------|------|--------|
| **refill_maskç”¨é€”** | âœ“ ç”¨äºæŒ‡å¯¼æ­£åˆ™åŒ– | âœ— ä¸ä½¿ç”¨ |
| **å‰ªææ–¹å¼** | è½¯å‰ªæï¼ˆæ­£åˆ™åŒ–å‹ç¼©ï¼‰ | ç¡¬å‰ªæï¼ˆç›´æ¥è®¾ä¸º0ï¼‰ |
| **æŠ¥å‘Šç¨€ç–åº¦** | 0%ï¼ˆæƒé‡æ¥è¿‘0ä½†ä¸ä¸º0ï¼‰ | å‡†ç¡®ï¼ˆæƒé‡ç¡®å®ä¸º0ï¼‰ |
| **è¿­ä»£æ–¹å¼** | æ¸è¿›å¼ï¼ˆå¤šæ¬¡è¿­ä»£é€æ­¥å‹ç¼©ï¼‰ | ä¸€æ¬¡æ€§ï¼ˆæ¯æ¬¡è¿­ä»£é‡æ–°è°ƒæ•´ï¼‰ |
| **fillbackåŠŸèƒ½** | ä¸æ”¯æŒï¼ˆfillback_rate=0.0ï¼‰ | æ”¯æŒï¼ˆå¯æ¢å¤æƒé‡ï¼‰ |
| **update_regè°ƒç”¨** | âœ“ æ¯ä¸ªbatchè°ƒç”¨ | âœ— ä¸è°ƒç”¨ |

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## ğŸ’¡ å…³é”®ç†è§£

### Q1: ä¸ºä»€ä¹ˆRSSTéœ€è¦refill_maskï¼Œè€ŒRefillä¸éœ€è¦ï¼Ÿ

**A**: 

**RSST**ï¼š
- ç›®æ ‡ï¼šé€šè¿‡æ­£åˆ™åŒ–**æ¸è¿›å¼**å‹ç¼©æƒé‡
- éœ€è¦`refill_mask`å‘Šè¯‰`update_reg()`ï¼šå“ªäº›æƒé‡åº”è¯¥è¢«å‹ç¼©
- æµç¨‹ï¼šä¿å­˜mask â†’ è®­ç»ƒæ—¶åº”ç”¨æ­£åˆ™åŒ– â†’ ä¸‹ä¸€æ¬¡è¿­ä»£é‡æ–°ç”Ÿæˆmask

**Refill**ï¼š
- ç›®æ ‡ï¼š**ä¸€æ¬¡æ€§**è°ƒæ•´æƒé‡ï¼ˆå‰ªæ+æ¢å¤ï¼‰
- ç›´æ¥ä¿®æ”¹æ¨¡å‹æƒé‡ï¼Œä¸éœ€è¦åç»­æ­£åˆ™åŒ–
- æµç¨‹ï¼šç”Ÿæˆmask â†’ ç«‹å³åº”ç”¨ â†’ è®­ç»ƒï¼ˆæ— æ­£åˆ™åŒ–ï¼‰

---

### Q2: current_maskå’Œrefill_maskçš„å…³ç³»ï¼Ÿ

**å½¢è±¡æ¯”å–»**ï¼š

```
current_maskï¼šæ¨¡å‹çš„"ç°çŠ¶æŠ¥å‘Š"
  - è®°å½•ï¼šå½“å‰å“ªäº›æƒé‡è¿˜æ´»ç€ï¼ˆL1å‰ªæçš„ç»“æœï¼‰
  - æ¥æºï¼šextract_mask(model.state_dict())

refill_maskï¼šæ¨¡å‹çš„"æœªæ¥è§„åˆ’"
  - è®°å½•ï¼šå“ªäº›æƒé‡åº”è¯¥ä¿ç•™ï¼Œå“ªäº›åº”è¯¥è¢«å‰ªæ
  - æ¥æºï¼šåŸºäºé‡è¦æ€§criteriaé‡æ–°è¯„ä¼°
  - ä½œç”¨ï¼šæŒ‡å¯¼ä¸‹ä¸€æ¬¡è¿­ä»£çš„æ­£åˆ™åŒ–ç›®æ ‡

unpruned_indicesï¼šéœ€è¦æ‰§è¡Œçš„"è¡ŒåŠ¨è®¡åˆ’"
  - å®šä¹‰ï¼š(refill_mask=0 & current_mask=1)
  - å«ä¹‰ï¼šå½“å‰è¿˜æ´»ç€ï¼Œä½†æœªæ¥åº”è¯¥æ­»çš„æƒé‡
  - è¡ŒåŠ¨ï¼šé€šè¿‡æ­£åˆ™åŒ–é€æ¸å‹ç¼©è¿™äº›æƒé‡
```

---

### Q3: ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨refill_maskæ›¿æ¢current_maskï¼Ÿ

**A**: å› ä¸ºå®ƒä»¬çš„ä½œç”¨ä¸åŒï¼

```python
# âŒ é”™è¯¯ç†è§£
current_mask = refill_mask  # ä¸èƒ½è¿™æ ·ï¼

# âœ“ æ­£ç¡®ç†è§£
# current_maskï¼šL1å‰ªæçš„ç»“æœï¼ˆå®¢è§‚äº‹å®ï¼‰
# refill_maskï¼šé‡ç»„åçš„ç›®æ ‡ï¼ˆä¸»è§‚æ„å›¾ï¼‰
# unpruned_indicesï¼šä¸¤è€…çš„å·®å¼‚ï¼ˆéœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼‰
```

**ç±»æ¯”**ï¼š
- `current_mask`ï¼šä½ çš„å½“å‰å·¥èµ„ï¼ˆç°çŠ¶ï¼‰
- `refill_mask`ï¼šä½ æœŸæœ›çš„å·¥èµ„ï¼ˆç›®æ ‡ï¼‰
- `unpruned_indices`ï¼šå·¥èµ„å·®è·ï¼ˆéœ€è¦åŠªåŠ›çš„æ–¹å‘ï¼‰

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## ğŸ¯ å®é™…ä¾‹å­ï¼šViT Headçº§åˆ«å‡†ç»“æ„åŒ–å‰ªæ

### åœºæ™¯
- ViT-Tinyï¼Œ3ä¸ªheads
- è¿­ä»£Nè®­ç»ƒå®Œæˆ

### Step 1: L1å…¨å±€å‰ªæï¼ˆelement-wiseï¼‰

```
QKVæƒé‡ï¼ˆ3 heads Ã— 64 dim = 192ç»´ï¼‰ï¼š

Head 0: [1,1,0,1,1,0,...,1] â†’ 50ä¸ª1ï¼Œ14ä¸ª0ï¼ˆ22%ç¨€ç–ï¼‰
Head 1: [1,1,1,1,1,1,...,1] â†’ 60ä¸ª1ï¼Œ4ä¸ª0ï¼ˆ6%ç¨€ç–ï¼‰
Head 2: [0,0,1,0,1,0,...,0] â†’ 30ä¸ª1ï¼Œ34ä¸ª0ï¼ˆ53%ç¨€ç–ï¼‰

current_mask = [æ‰€æœ‰elementçš„mask]
  â€¢ Head 0: 22%ç¨€ç–
  â€¢ Head 1: 6%ç¨€ç–
  â€¢ Head 2: 53%ç¨€ç–
```

### Step 2: Headçº§åˆ«é‡ç»„ï¼ˆå‡†ç»“æ„åŒ–ï¼‰

```python
# è®¡ç®—æ¯ä¸ªheadçš„é‡è¦æ€§
importance = [
    head0: 50 (éé›¶æƒé‡æ•°),
    head1: 60,
    head2: 30
]

# ä¿ç•™top-2 headsï¼ˆprune_ratio=0.3ï¼‰
heads_to_keep = [1, 0]  # Head 1æœ€é‡è¦ï¼ŒHead 0æ¬¡ä¹‹

# ç”Ÿæˆheadçº§åˆ«çš„refill_mask
refill_mask = [
    Head 0: [1,1,1,1,1,1,...,1],  # å…¨1ï¼ˆä¿ç•™ï¼‰
    Head 1: [1,1,1,1,1,1,...,1],  # å…¨1ï¼ˆä¿ç•™ï¼‰
    Head 2: [0,0,0,0,0,0,...,0]   # å…¨0ï¼ˆå‰ªæï¼‰
]
```

### Step 3: æ‰¾å‡ºéœ€è¦æ­£åˆ™åŒ–çš„æƒé‡

```python
unpruned_indices = torch.where((refill_mask == 0) & (current_mask == 1))

# ç»“æœï¼š
unpruned_indices = [
    Head 0: []           # refill=1ï¼Œä¸éœ€è¦æ­£åˆ™åŒ–
    Head 1: []           # refill=1ï¼Œä¸éœ€è¦æ­£åˆ™åŒ–
    Head 2: [2,4,...]    # è¿™äº›ç´¢å¼•ï¼šcurrent=1ä½†refill=0
]
# Head 2ä¸­è¿˜æœ‰30ä¸ªæƒé‡ä¸º1ï¼ˆcurrent_maskï¼‰ï¼Œ
# ä½†æ•´ä¸ªheadè¢«æ ‡è®°ä¸ºåº”è¯¥å‰ªæï¼ˆrefill_mask=0ï¼‰ï¼Œ
# æ‰€ä»¥è¿™30ä¸ªæƒé‡éƒ½éœ€è¦è¢«æ­£åˆ™åŒ–å‹ç¼©
```

### Step 4: åº”ç”¨æ­£åˆ™åŒ–ï¼ˆä¸‹ä¸€æ¬¡è¿­ä»£ï¼‰

```python
# è®­ç»ƒæ—¶ï¼ŒHead 2çš„æƒé‡ä¼šè¢«æ–½åŠ é¢å¤–çš„L2æ­£åˆ™åŒ–
for batch in train_loader:
    loss.backward()
    update_reg()  # å¯¹Head 2çš„30ä¸ªéé›¶æƒé‡åº”ç”¨æ­£åˆ™åŒ–
    optimizer.step()

# ç»è¿‡80 epochsåï¼š
# Head 2çš„æƒé‡ï¼š[0,0,0.01,0,0.005,0,...,0]
# å¤§éƒ¨åˆ†æƒé‡è¢«å‹ç¼©åˆ°æ¥è¿‘0ï¼
```

### Step 5: ä¸‹ä¸€æ¬¡è¿­ä»£çš„L1å‰ªæ

```
å› ä¸ºHead 2çš„æƒé‡å·²ç»å¾ˆå°ï¼Œ
L1å‰ªææ—¶ä¼šä¼˜å…ˆå‰ªæ‰è¿™äº›æƒé‡ï¼Œ
æœ€ç»ˆHead 2ä¼šè¢«å®Œå…¨å‰ªæ‰ï¼ˆå‡†ç»“æ„åŒ–æ•ˆæœï¼‰
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## ğŸ“ æ€»ç»“

### current_mask vs refill_mask

| Mask | å«ä¹‰ | æ¥æº | ç”¨é€” |
|------|------|------|------|
| **current_mask** | å½“å‰ä¿ç•™çš„æƒé‡ | L1å…¨å±€å‰ªæ | è®°å½•ç°çŠ¶ |
| **refill_mask** | åº”è¯¥ä¿ç•™çš„æƒé‡ | é‡è¦æ€§é‡ç»„ | æŒ‡å¯¼æ­£åˆ™åŒ– |
| **unpruned_indices** | éœ€è¦å‹ç¼©çš„æƒé‡ | ä¸¤è€…äº¤é›† | æ­£åˆ™åŒ–ç›®æ ‡ |

### RSST vs Refill

| ç®—æ³• | ä½¿ç”¨refill_mask? | å‰ªææ–¹å¼ | ç‰¹ç‚¹ |
|------|-----------------|----------|------|
| **RSST** | âœ“ æ˜¯ | è½¯å‰ªæï¼ˆæ­£åˆ™åŒ–ï¼‰ | æ¸è¿›å¼ï¼Œç¨€ç–åº¦0% |
| **Refill** | âœ— å¦ | ç¡¬å‰ªæï¼ˆç›´æ¥è®¾0ï¼‰ | ä¸€æ¬¡æ€§ï¼Œç¨€ç–åº¦å‡†ç¡® |

### æ ¸å¿ƒæœºåˆ¶

```python
# RSSTçš„æ ¸å¿ƒå¾ªç¯
for iteration in range(20):
    # 1. è®­ç»ƒï¼ˆä½¿ç”¨ä¸Šæ¬¡çš„refill_maskè¿›è¡Œæ­£åˆ™åŒ–ï¼‰
    train_with_regularization(refill_mask)
    
    # 2. L1å…¨å±€å‰ªæ
    current_mask = l1_pruning(model)
    
    # 3. é‡ç»„maskï¼ˆå‡†ç»“æ„åŒ–å†³ç­–ï¼‰
    refill_mask = regroup_mask(current_mask, criteria)
    
    # 4. ä¸‹ä¸€æ¬¡è¿­ä»£ä½¿ç”¨refill_maskæŒ‡å¯¼æ­£åˆ™åŒ–
```

**å…³é”®å…¬å¼**ï¼š
```python
unpruned_indices = (refill_mask == 0) & (current_mask == 1)
```

è¿™ä¸ªå…¬å¼æ˜¯RSSTç®—æ³•çš„æ ¸å¿ƒï¼Œå®ƒæ‰¾å‡ºï¼š
- **å½“å‰è¿˜æ´»ç€ï¼ˆcurrent_mask=1ï¼‰**
- **ä½†æœªæ¥åº”è¯¥æ­»çš„ï¼ˆrefill_mask=0ï¼‰**
- **æƒé‡**

é€šè¿‡æ­£åˆ™åŒ–ï¼Œè¿™äº›æƒé‡ä¼šè¢«æ¸è¿›å¼å‹ç¼©ï¼Œæœ€ç»ˆåœ¨L1å‰ªæä¸­è¢«è‡ªç„¶å‰ªæ‰ã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ **ç†è§£è¿™ä¸¤ä¸ªmaskçš„å…³ç³»ï¼Œå°±ç†è§£äº†RSSTç®—æ³•çš„ç²¾é«“ï¼**

